/*! RTT.gl v1.0.0 | (c) 2015 Johann Troendle | https://github.com/JoTrdl/rtt.gl */
!function(t){"use strict";var e={};e.createProgram=function(t,e,r){var i,s,h=t.createProgram();try{i=this.compileShader(t,e,t.VERTEX_SHADER),s=this.compileShader(t,r,t.FRAGMENT_SHADER)}catch(o){throw t.deleteProgram(h),o}return t.attachShader(h,i),t.deleteShader(i),t.attachShader(h,s),t.deleteShader(s),t.linkProgram(h),h},e.compileShader=function(t,e,r){var i=t.createShader(r);if(t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS)){for(var s=t.getShaderSource(i).split("\n"),h="",o=0;o<s.length;o++)h+=o+1+"."+s[o]+"\n";throw"GLSL Compilation Error:\n"+t.getShaderInfoLog(i)+"\n"+h}return i},e.createTexture=function(t,e,r,i){var s=i&&i.type||t.UNSIGNED_BYTE,h=i&&i.minFilter||t.NEAREST,o=i&&i.magFilter||t.NEAREST,a=i&&i.wrapS||t.CLAMP_TO_EDGE,n=i&&i.wrapT||t.CLAMP_TO_EDGE,u=i&&i.input||null,f=t.createTexture();return t.bindTexture(t.TEXTURE_2D,f),u?(t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,u)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,r,0,t.RGBA,s,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,h),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,n),t.bindTexture(t.TEXTURE_2D,null),f};var r=["attribute vec2 position;","varying vec2 vUv;","void main() {","vUv =  position;","vec2 vPos = position * 2.0 - 1.0;","gl_Position = vec4(vPos.x, vPos.y, 0, 1);","}"].join("\n"),i=["precision highp float;","uniform sampler2D tSampler;","varying vec2 vUv;","void main() {","  gl_FragColor = texture2D(tSampler, vUv);","}"].join("\n"),s=new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]),h=s.length/2,o=function(t,e,r,i,s,h){var o=t.getUniformLocation(e,i);if(null!==s&&o){var a=[o];if(s.length?a=a.concat(s):a.push(s),h)if(r.call(t,o,s),h.length)for(var n=0;n<h.length;n++)t.activeTexture(t.TEXTURE0+s[n]),t.bindTexture(t.TEXTURE_2D,h[n]);else t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,h);else r.apply(t,a)}},a=function(t,e,r,i,s,h){var o=t.getAttribLocation(e,r);0>o||(t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),t.enableVertexAttribArray(o),t.vertexAttribPointer(o,i,t.FLOAT,!1,0,0))},n=function(t,e){return this.options=e||{},this.gl=t,this.gl&&this.gl instanceof WebGLRenderingContext?(this.width=this.options.width||t.canvas.width,this.height=this.options.height||t.canvas.height,this.viewportWidth=this.options.viewportWidth||t.canvas.width,this.viewportHeight=this.options.viewportHeight||t.canvas.height,void this.reset(!0)):void console.log("Error, paramater [gl] must be a WebGL context")};n.prototype.resize=function(t){var e=this.gl;this.width=t&&t.width||e.canvas.width,this.height=t&&t.height||e.canvas.height,this.viewportWidth=t&&t.viewportWidth||e.canvas.width,this.viewportHeight=t&&t.viewportHeight||e.canvas.height;for(var r=0;r<this.textures.length;r++){var i=this.options.texture&&this.options.texture.type||e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,this.textures[r]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,i,null)}for(var r=0;r<this.history.length;r++){var i=this.options.texture&&this.options.texture.type||e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,this.history[r]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,i,null)}return this},n.prototype.reset=function(t){var o=this.gl;if(!t){var a;for(a=0;a<this.textures.length;a++)o.deleteTexture(this.textures[a]);for(a=0;a<this.shaders.length;a++)o.deleteProgram(this.shaders[a]);for(o.deleteFramebuffer(this.frameBuffer),o.deleteBuffer(this.geometryBuffer),a=0;a<this.history.length;a++)o.deleteTexture(this.history[a])}this.shaders=[],this.attributes=[],this.uniforms=[],this.frameBuffer=o.createFramebuffer(),this.textures=[e.createTexture(o,this.width,this.height,this.options.texture),e.createTexture(o,this.width,this.height,this.options.texture)],this.history=new Array(this.options.history+1||0);for(var a=0;a<this.history.length;a++)this.history[a]=e.createTexture(o,this.width,this.height,this.options.texture);return this.renderIndex=0,this.quadBuffer=o.createBuffer(),this.paintShader=e.createProgram(o,r,i),o.bindBuffer(o.ARRAY_BUFFER,this.quadBuffer),this.quadVertices=new Float32Array(s),this.geometryBuffer=this.quadBuffer,this.vertices=this.quadVertices,this.geometry=[o.TRIANGLE_STRIP,0,h],this.options.geometry&&(this.geometryBuffer=o.createBuffer(),this.vertices=this.options.geometry.shift(),this.geometry=this.options.geometry),this},n.prototype.fragment=function(t,e){return this.vertexFragment(r,t,e)},n.prototype.vertexFragment=function(t,r,i,s){var h=e.createProgram(this.gl,t,r);this.shaders.push(h),this.uniforms.push(i);for(var o in s)s[o].buffer=gl.createBuffer();return this.attributes.push(s),this},n.prototype.image=function(t){var s=e.createTexture(gl,this.width,this.height,{input:t}),h={tSampler:{type:"t",value:s}};return this.vertexFragment(r,i,h)},n.prototype.render=function(){var t,e,r,i,s,h=this.gl;for(e=0;e<this.shaders.length;e++){i=0,this.renderIndex=(this.renderIndex+1)%2,t=this.output,this.output=this.textures[this.renderIndex],this.history.length&&e==this.shaders.length-1&&(this.history.unshift(this.history.pop()),this.output=this.history[0]),h.useProgram(this.shaders[e]),h.bindFramebuffer(h.FRAMEBUFFER,this.frameBuffer),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,this.output,0),a(h,this.shaders[e],"position",2,this.geometryBuffer,this.vertices);var n=this.attributes[e]||{};for(var u in n)a(h,this.shaders[e],u,n[u].size,n[u].buffer,n[u].data);o(h,this.shaders[e],h.uniform1i,"tSampler",i,t),i++;var f=this.uniforms[e]||{};for(var p in f)"t"==f[p].type?(o(h,this.shaders[e],h.uniform1i,p,i,f[p].value),i++):o(h,this.shaders[e],h["uniform"+f[p].type],p,f[p].value);if(this.history.length){for(s=[],r=1;r<this.history.length;r++)s.push(++i);o(h,this.shaders[e],h.uniform1iv,"tHistory",s,this.history.slice(1))}h.viewport(0,0,this.width,this.height),h.drawArrays.apply(h,this.geometry)}return this},n.prototype.iterate=function(t){for(var e=this.shaders[this.shaders.length-1],r=this.uniforms[this.uniforms.length-1],i=0;t>i;i++)this.shaders.push(e),this.uniforms.push(r);return this},n.prototype.swap=function(){var t=this.textures[0];return this.textures[0]=this.textures[1],this.textures[1]=t,this},n.prototype.clear=function(){if(!this.output)return this;var t=this.gl;return t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this},n.prototype.paint=function(){if(!this.output)return console.log("Error: no output to paint. Call render() at least once."),this;var t=this.gl;return t.useProgram(this.paintShader),t.bindFramebuffer(t.FRAMEBUFFER,null),a(t,this.paintShader,"position",2,this.quadBuffer,this.quadVertices),o(t,this.paintShader,t.uniform1i,"tSampler",0,this.output),t.viewport(0,0,this.viewportWidth,this.viewportHeight),t.drawArrays(t.TRIANGLE_STRIP,0,h),this},t.RTT=n}(window);
